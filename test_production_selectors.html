<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Product Selector –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/crm/css/product_selector.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>–¢–µ—Å—Ç Product Selector –≤ –º–æ–¥—É–ª—è—Ö –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h2>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>–†–µ—Ü–µ–ø—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –ø—Ä–æ–¥—É–∫—Ç</label>
                            <div class="product-selector-container" id="main-product-selector"></div>
                            <input type="hidden" id="product_id" name="product_id">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç 1</label>
                            <div class="product-selector-container ingredient-selector" data-ingredient-id=""></div>
                            <input type="hidden" name="ingredients[0][ingredient_id]">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</label>
                            <div class="product-selector-container" id="new-ingredient-selector"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>–û–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                                    <th>–¢—Ä–µ–±—É–µ—Ç—Å—è</th>
                                    <th>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏</th>
                                    <th>–ï–¥. –∏–∑–º.</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div class="product-selector-container ingredient-selector" data-ingredient-id=""></div>
                                        <input type="hidden" name="ingredients[0][ingredient_id]">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" value="1.00">
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" value="0.00">
                                    </td>
                                    <td class="ingredient-unit">—à—Ç</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary" onclick="testSelectors()">–¢–µ—Å—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤</button>
            <button class="btn btn-info" onclick="checkConsole()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/crm/js/product_selector.js"></script>
    
    <script>
        console.log('üü¢ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        const ALL_PRODUCTS = [
            {id: 1, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 1', unit_of_measure: '—à—Ç', cost_price: 100, sale_price: 150},
            {id: 2, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 2', unit_of_measure: '–∫–≥', cost_price: 50, sale_price: 80},
            {id: 3, name: '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 3', unit_of_measure: '–ª', cost_price: 25, sale_price: 40}
        ];
        
        let mainProductSelector = null;
        let newIngredientSelector = null;
        
        $(document).ready(function() {
            console.log('üìã –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ createProductSelector
            if (typeof createProductSelector === 'undefined') {
                console.error('‚ùå –§—É–Ω–∫—Ü–∏—è createProductSelector –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                alert('–û—à–∏–±–∫–∞: Product Selector –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                return;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ–ª–µ–∫—Ç–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞
            try {
                mainProductSelector = createProductSelector('#main-product-selector', {
                    context: 'production',
                    placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –ø—Ä–æ–¥—É–∫—Ç...',
                    onSelect: function(product) {
                        $('#product_id').val(product.id);
                        console.log('‚úÖ –í—ã–±—Ä–∞–Ω –ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –ø—Ä–æ–¥—É–∫—Ç:', product.name);
                    },
                    onClear: function() {
                        $('#product_id').val('');
                    }
                });
                console.log('‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞:', e);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
            try {
                newIngredientSelector = createProductSelector('#new-ingredient-selector', {
                    context: 'production',
                    placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç...',
                    onSelect: function(product) {
                        console.log('‚úÖ –í—ã–±—Ä–∞–Ω –Ω–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:', product.name);
                    },
                    onClear: function() {
                        console.log('üîÑ –û—á–∏—â–µ–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞');
                    }
                });
                console.log('‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (e) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:', e);
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
            initializeIngredientSelectors();
        });
        
        function initializeIngredientSelectors() {
            $('.ingredient-selector').each(function() {
                if ($(this).hasClass('selector-initialized')) {
                    return;
                }
                
                const $container = $(this);
                const $row = $container.closest('tr');
                
                try {
                    const ingredientSelector = createProductSelector(this, {
                        context: 'production',
                        placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç...',
                        onSelect: function(product) {
                            $row.find('input[name$="[ingredient_id]"]').val(product.id);
                            $row.find('.ingredient-unit').text(product.unit_of_measure || '—à—Ç');
                            console.log('‚úÖ –í—ã–±—Ä–∞–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç:', product.name);
                        },
                        onClear: function() {
                            $row.find('input[name$="[ingredient_id]"]').val('');
                            $row.find('.ingredient-unit').text('—à—Ç');
                        }
                    });
                    
                    $container.addClass('selector-initialized');
                    console.log('‚úÖ –°–µ–ª–µ–∫—Ç–æ—Ä –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                } catch (e) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:', e);
                }
            });
        }
        
        function testSelectors() {
            console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤...');
            
            // –¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
            if (mainProductSelector) {
                console.log('üìã –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ–ª–µ–∫—Ç–æ—Ä:', mainProductSelector);
                console.log('üìã –ú–µ—Ç–æ–¥—ã —Å–µ–ª–µ–∫—Ç–æ—Ä–∞:', Object.keys(mainProductSelector));
            }
            
            // –¢–µ—Å—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
            if (newIngredientSelector) {
                console.log('üìã –°–µ–ª–µ–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:', newIngredientSelector);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
            const initializedCount = $('.selector-initialized').length;
            console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤:', initializedCount);
            
            alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
        }
        
        function checkConsole() {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:');
            console.log('- createProductSelector –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof createProductSelector !== 'undefined');
            console.log('- jQuery –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof $ !== 'undefined');
            console.log('- –°–µ–ª–µ–∫—Ç–æ—Ä—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:', $('.product-selector-container').length);
            console.log('- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã:', $('.selector-initialized').length);
        }
    </script>
</body>
</html> 